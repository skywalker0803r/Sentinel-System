# Discord Field 字符限制修復報告

## 問題分析

根據後端日誌，Discord API 返回錯誤：
```
discord.errors.HTTPException: 400 Bad Request (error code: 50035): Invalid Form Body
In embeds.0.fields.1.value: Must be 1024 or fewer in length.
In embeds.0.fields.2.value: Must be 1024 or fewer in length.
```

## 根本原因

Discord embed 的每個 field 的 value 不能超過 1024 個字符，但我們添加的 SMC 價格區間信息使得單個訊號的字符數增加，導致多個訊號組合後超出限制。

## 解決方案

### 1. 字符長度測試結果
- **單個訊號**: ~218 字符
- **2個訊號組合**: ~438 字符 ✅ 安全
- **3個訊號組合**: ~658 字符 ✅ 理論安全，但留有余量更穩定

### 2. 實施的修復措施

#### A. 簡化價格區間顯示格式
**修改前**:
```
🔴 **高價區**: `$0.012500-$0.013200`
🟢 **低價區**: `$0.008900-$0.009600`
```

**修改後**:
```
🔴`$0.012500-$0.013200` 🟢`$0.008900-$0.009600`
```
**節省字符**: ~30 字符/訊號

#### B. 調整 Field 分割策略
- **修改前**: 嘗試將所有訊號放在少數 field 中
- **修改後**: 每個 field 最多2個訊號，確保穩定性

#### C. 動態 Field 命名
```python
# 自動計算每個 field 的訊號範圍
start_num = i + 1
end_num = min(i + signals_per_field, len(top_signals))

if i == 0:
    field_name = f"🏆 TOP 做多推薦 ({start_num}-{end_num})"
else:
    field_name = f"📈 做多推薦 ({start_num}-{end_num})"
```

### 3. 代碼變更摘要

#### 文件: `bot.py`

1. **第539行**: 簡化價格區間顯示格式
2. **第554行**: 調整每個field最大訊號數從3個改為2個
3. **第561-566行**: 改進field命名邏輯，動態計算範圍

## 預期效果

### 顯示效果
現在每個 field 最多顯示2個做多推薦，例如：

```
🏆 TOP 做多推薦 (1-2)
🥇 1. SPA_USDT 🚀 70分
💰 $0.010768 | 📊 向上突破 | 🏦 10.58%
🎯 趨勢轉變 | 10個大單區 | 大戶洗盤 | 🟡平衡區
🔴$0.012500-$0.013200 🟢$0.008900-$0.009600
📊 評分明細: 技術突破: 25分 | 趨勢轉變: 20分

🥈 2. UNFI_USDT 🚀 70分
💰 $0.224800 | 📊 向上突破 | 🏦 7.83%
🎯 趨勢轉變 | 10個大單區 | 大戶洗盤 | 🟡平衡區
🔴$0.280000-$0.295000 🟢$0.180000-$0.195000
📊 評分明細: 技術突破: 25分 | 趨勢轉變: 20分

📈 做多推薦 (3-4)
[後續訊號...]
```

### 穩定性保障
- 每個 field 字符數控制在 ~450 字符以內
- 遠低於 1024 字符限制，留有充足安全邊距
- 支持動態擴展，無論訊號數量多少都能正確分割

## 功能完整性

✅ **保持所有新功能**:
- SMC 高價區和低價區顯示
- 價格區間計算邏輯
- 評分系統和說明

✅ **解決技術問題**:
- Discord API 字符限制
- Field 數量和長度管理
- 穩定的顯示格式

## 測試建議

1. 運行修復後的 bot.py
2. 檢查 Discord 消息是否正常發送
3. 驗證所有做多推薦都正確顯示
4. 確認 SMC 價格區間信息完整

---

**修復完成時間**: 2024年12月
**影響文件**: `bot.py`
**狀態**: 準備測試